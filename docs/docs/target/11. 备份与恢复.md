# 11. 备份与恢复

​	说数据库备份之前先讲一个发生在我身边的小故事，在我开始做程序员的时候，经常会在网上看到误删数据库的帖子，甚至同事们之间偶尔还拿这种话题开玩笑，当时我挺纳闷的，误删数据库到底是怎么做到的呢？这个疑问在我心中徘徊了很久，直到有一天，我身边的一个同事真的把生产环境的数据库给删了！

​	开始他找我求助时只是说数据库服务无法启动了，还把启动报错给我看，然后他又说他在网上看了个帖子，执行了命令 `rm -rf /var/lib/mysql` ，然后服务就再也起不来了，当时我一声 `wo cao` 就给他发过去了，确认后发现真的是把数据库的数据文件给删除了!这还不是最可怕的，最可怕的是生产环境的数据库居然没有开定期的数据备份，更没有开二进制日志备份。能找到的最近的一次逻辑备份还是几个月之前的数据。**在软件开发行业里，删除数据库算是一级重大事故了，删除数据库后发现还没有数据备份，那没有比这种情况更严重的事故了。**

​	所以删库还不是最可怕的事情，如果备份策略很完善，即便删库，也有“后悔药”可吃，不会造成很大的损失，但如果删了库还没有数据备份，那后果是糟糕到不能再糟糕了。

## 11.1 备份方法

​	数据备份的本质是建立冗余数据进行数据转储。根据备份过程中数据库服务的运行状态，可分为三类：

- 冷备份
- 热备份
- 温备份

​	热备份是指在备份期间，数据库对外提供正常服务，在数据库运行中即可备份；冷备份是指在数据库服务停止的情况下，备份物理文件，这种备份最简单，最直接，不过在生产环境下不太实用；温备份也是在数据库服务运行中备份，不过通常加一个全局读锁以保证备份数据的一致性，温备份期间，数据库对外提供非正常服务，只能读取数据，不能写入数据。

​	按照数据备份的范围，可分为：

- 全量备份
- 增量备份
- 日志备份

​	全量备份是指对完整的数据库进行备份。增量备份是指在上次全量备份的基础上，对更改的数据进行备份。日志备份指的是MySQL二进制日志的备份，使用二进制日志备份可进行基于时间点的数据恢复，MySQL数据库主从复制也是基于二进制日志实现的。

​	二进制日志备份不属于真正意义上的增量备份，官方并没有提供真正的增量备份方法，大部分是通过二进制日志来完成增量备份，但这种备份较真正的增量备份来说，效率较低。举个例子，自从上次完整备份以来，数据A先后被修改为B，再修改为C，最后又修改为A，从增量备份的定义上来说，现在时间点与上次完整备份的时间点相比，数据A并没有发生变化，也就不需要增量备份这部分数据。但二进制日志会把这段时间内数据A的所有变化记录在内，备份和恢复时间肯定比增量备份要长一些。Xtrabackup 可以实现真正意义的增量备份。

​	按照数据备份的内容形式，可分为：

- 逻辑备份
- 物理备份



​	逻辑备份的内容是人们可直接阅读的文本，也就是以SQL的形式输出。物理备份



## 11.2 逻辑备份 

从数据备份方式上分，数据库备份分为**逻辑备份**和**物理备份**两种。`mysqldump` 是MySQL自带的逻辑备份工具。

### mysqldump

**语法:** 

```shell
# 备份单库或数据表
mysqldump [OPTIONS] database [tables]
# 备份单/多个数据库
mysqldump [OPTIONS] --databases [OPTIONS] DB1 [DB2 DB3...]
# 备份全部数据库
mysqldump [OPTIONS] --all-databases [OPTIONS]
```

常用选项：

| 参数名                  | 描述                             | 默认值 |
| ----------------------- | -------------------------------- | ------ |
| --host                  | 服务器IP地址                     |        |
| --port                  | 服务器端口号                     |        |
| -u                      | 用户名                           |        |
| -p                      | 密码                             |        |
| -v                      | 打印执行过程信息                 |        |
| --databases             | 指定要备份的数据库               |        |
| --all-databases         | 备份所有的数据库                 |        |
| **--lock-tables**       | 锁定操作数据库中的所有表（读锁） | true   |
| --lock-all-tables       | 锁定所有数据库中的所有表（读锁） | false  |
| --single-transaction    | 整个备份动作放入一个事务中       |        |
| --force                 | 出现错误时继续备份               | false  |
| --compact               | 压缩输出 (节省带宽)              | false  |
| --default-character-set | 指定字符集                       | utf8   |

控制输出语句的选项：

| 参数名              | 描述                                                         | 默认值 |
| ------------------- | ------------------------------------------------------------ | ------ |
| -n                  | 不输出创建数据库语句                                         |        |
| -t                  | 不输出创建表结构语句                                         |        |
| -d                  | 不输出增加表数据语句                                         |        |
| -R                  | 备份函数和存储过程                                           |        |
| --add-drop-database | 在每次创建之前添加一个DROP DATABASE                          | FALSE  |
| --add-drop-table    | 在每次创建之前添加一个DROP TABLE                             | TRUE   |
| --add-locks         | 在INSERT语句周围添加锁。（默认为开，使用--skip-add-locks禁用。） | TRUE   |
| --add-drop-trigger  | 在每次创建之前添加一个DROP TRIGGER                           | FALSE  |

注：更多用法使用 `mysqldump --help` 查询。

:warning: 警告：

​	默认情况下，mysqldump 在备份时会锁定数据库的所有表，直到备份完成。在此期间数据库对外只能读，不能写！所以**生产环境下的数据库，务必不要在有业务的时间段进行  mysqldump 逻辑备份！**因为备份期间会导致数据库服务不能提供正常服务。

​	如果你的服务在夜间或某个时间段几乎没有业务运行，那么可以在这个时间段进行逻辑备份（如 00:00 - 04:00 时间段），如果你的服务必须24小时不间断对外提供正常服务，那么 mysqldump 备份就不合适了，此时应该使用在线物理备份的方式进行数据备份。

​	`--lock-tables` 只是依次锁住操作的数据库中的所有表，因此只能保证单个库中备份数据的一致性，不能保证一个数据库实例下所有数据库的数据一致性。使用 `--lock-all-tables` 选项就可以锁住数据库实例的所有数据库的所有表，保证整个数据库实例备份数据的一致性。



### 备份数据 

```shell
# 备份指定数据表(多个表用空格隔开)
mysqldump -u root -p DB1 table1 table2 > ./backup/backup.sql
# 备份指定数据库
mysqldump -u root -p DB1 > ./backup/DB1.sql
# 备份指定数据库,忽略某些表
mysqldump -u root -p DB1 --ignore-table=DB1.table1 > ./backup/DB1.sql
# 备份所有数据库
mysqldump -u root -p --all-databases > ./backup/all.sql
```

注:

​	备份数据库时忽略某些表的写法是 `--ignore-table=database.table` ，等号左右不能有空格，必须是数据库名.表名；忽略多个表重复写 `--ignore-table` 即可；

### 还原数据

还原逻辑备份的数据非常简单，只需要让mysql执行这些SQL就可以了。SQL所含的数据量越大，还原时间越长。

```shell
# mysqldump 还原数据
mysql -u root -p DB1 < ./backup/DB1.sql
```

注：还原的数据库名必须存在，而且与备份文件的前缀名一致才可以；



**加快还原速度** 

​	使用逻辑备份还原数据库时，实际上是执行大量的 create table 和 insert 语句，mysql 持久化数据的执行机制是从缓冲存储到事务日志文件，再从事务日志文件同步到磁盘上，这一系列操作默认是同步的，可以通过临时调整系统参数，修改为异步执行，从而加快备份速度：

```mysql
set global innodb_flush_log_at_trx_commit = 0;  # 默认为策略1,策略0效率最高;
set global innodb_flush_log_at_timeout    = 3;  # 默认为1秒;
```

如果你的服务开启了 binlog，可以通过关闭 binglog ，或降低刷新频率加快备份速度：

```mysql
set global sync_binlog = 3000;  # 默认为0,修改为3000次写操作才同步刷新到磁盘一次;
```

:warning: 注意：

- ​	数据还原完毕后把参数再修改回来；
- ​	这种追求性能而舍弃安全的做法，尽量不要在生产环境中使用，建议在测试服务或本地服务使用；



## 11.3 物理备份

​	物理备份即备份物理文件，而不是导出逻辑SQL语句。物理备份又分为冷备份和热备份，冷备份是把数据库服务停掉，备份数据文件。热备份是在数据库服务不停止的情况下进行数据备份。

​	mysqldump 是逻辑备份，劣势是备份和恢复的速度较慢，如果数据库很大（如超过50G或100G），mysqldump备份就比较吃力。在数据量很大的情况才，优先使用物理备份。



### Xtrabackup 

Xtrabackup 是 Percona 公司开源的一款数据库热备份工具。在线热备份即备份时不影响数据读写。

官网: https://www.percona.com/software/mysql-database/percona-xtrabackup

**应用：** 

​	很多中小型企业都会选择云数据库（如阿里云），阿里云数据库RDS 的物理备份就是通过 Xtrabackup 实现的。

**对应版本：** 

​	MySQL 5.6及之前的版本需要安装 Percona XtraBackup 2.3 

​	MySQL 5.7版本需要安装 Percona XtraBackup 2.4 

​	MySQL 8.0版本需要安装 Percona XtraBackup 8.0 

**注意事项：**

​	Xtrabackup 目前**仅支持在Linux环境**下备份和恢复数据，官方没有提供其他环境的安装包，所以Windows和Mac OS 暂时无法使用。

使用XtraBackup 实现备份：

```shell
# 全量备份
./xtrabackup --backup --target-dir=/backup/base
# 增量备份
./xtrabackup --backup --target-dir=/backup/base --incremental-basedir=/backup/increment
```



### MySQL Enterprise Backup

​	MySQL 企业级备份方案，支持各种姿势的备份，特点是需要花钱买。



## 11.4 二进制日志备份

​	指定每天 02:00 时分进行一次数据完整备份，如果在18:00 时数据库发生勿删操作（删表或删库），那么想要恢复被删除的数据，只能找到最近一次的完整数据备份并还原，可 02:00 - 18:00 期间的数据就丢失了！所以只有最近数据的完整备份是不够的，还需要备份二进制日志。

​	有了二进制日志和数据完整备份，理论上可以恢复最近任意时间点的数据，也就是说可以做基于时间点的数据恢复。



### 使用binlog恢复数据

binlog恢复数据有两种方式：

- 使用事件时间点进行恢复
- 使用事件位置点进行恢复

我们使用 mysqlbinlog 工具来操作binlog：

```shell
mysqlbinlog [options] log-files
```

**使用事件时间点进行恢复** 

假如在2017年4月20日上午10:00，执行了一个删除的SQL语句。事后要还原表和数据，执行如下命令：

```shell
shell> mysqlbinlog --stop-datetime="2017-04-20 9:59:59" \  
         /var/lib/mysql/mysql-bin.000001 | mysql -u root -p  
```

这样，截止到 "2017-04-20 9:59:59" 时间点的数据就全部恢复了。

如果还需要恢复2017年4月20日上午10:00之后发生的活动。可以用命令：

```shell
shell> mysqlbinlog --start-datetime="2017-04-20 10:01:00" \  
         /var/lib/mysql/mysql-bin.000001 | mysql -u root -p  
```

**使用事件位置点进行恢复**

```shell
shell> mysqlbinlog --stop-position=368312  /var/lib/mysql/mysql-bin.000001 \  
         | mysql -u root -p  
shell> mysqlbinlog --start-position=368315  /var/lib/mysql/mysql-bin.000001 \  
         | mysql -u root -p 
```



binlog 和 redo log 的区别和联系：

​	binlog 记录的是数据的逻辑变化（SQL或以某些符号分割的文本）。redo log 记录的是数据页的物理变化。

​	二进制日志 binlog 是MySQL服务层实现的功能，与存储引擎无关。**binlog优先于事务日志被记录。**



**特别注意：** 

​	**`expire-log-days` 参数应该设置的足够长，至少可以从最近的两次物理备份中做基于时间点的恢复。** 如果数据备份的周期是2天一次，那么 Binlog 的保留天数**至少**是2天。



## 11.5 数据库备份策略

**强烈建议数据备份和binlog 备份都开启！** 
数据库如果数据量很大, 推荐使用物理备份；Mysqldump 逻辑备份期间会锁库，如果不能接受，也要选择物理备份；
推荐备份保留30天, 至少保留7天;
推荐 备份位置为远程主机，而不是本机；
binlog 记录格式为 row (基于行的复制)



逻辑备份注意事项：

​	如果使用 Mysqldump 逻辑备份全量数据，一定要注意备份时间，选在几乎不会产生业务数据的时间段，因为逻辑备份期间，数据库中的所有表是不能写入数据的，也就意味着不能对外提供正常服务。

​	对于数据量很大的库，逻辑备份时常在10分钟、20分钟，甚至是半小时以上都有可能，数据量越大，备库时间越长，对于生产库来说，长时间不能对外访问，其实是糟糕的一件事情，试想一下，如果备库时间为半小时左右，那么MySQL服务的可用性就降低了2%，在一天中有2%的时间是无法正常使用MySQL数据库的。所以对于数据量大的数据库，应该优先使用物理备份。



